<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Vokabeln</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <style>
    .search-bar {
      max-width: 400px;
      position: relative;
    }

    .input-group-text {
      background-color: #e9ecef;
    }

    #suggestionBox {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      z-index: 10;
    }

    #suggestionBox .list-group-item {
      cursor: pointer;
      padding: 0.5rem 1rem;
      display: flex;
      align-items: center;
    }

    #suggestionBox .list-group-item:hover {
      background-color: #f1f1f1;
    }

    .bi-volume-up-fill {
      cursor: pointer;
      transition: transform 0.2s;
    }

    .bi-volume-up-fill:hover {
      transform: scale(1.2);
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <ul>
      <li>
        <a href="#" id="toggleSidebar" class="nav-link">
          <i class="bi bi-list toggle-btn"></i> <span>Navigation</span>
        </a>
      </li>
      <li><a href="/"><i class="bi bi-house-door-fill"></i> <span>Home</span></a></li>
      <li><a href="/favorite" class="active"><i class="bi bi-star-fill"></i> <span>Vokabeln</span></a></li>
      <li><a href="/quiz"><i class="bi bi-patch-question-fill"></i> <span>Vokabeltest</span></a></li>
      <li><a href="/lernen"><i class="bi bi-book-half"></i> <span>Lernen</span></a></li>
      <li><a href="/dashboard"><i class="bi bi-bar-chart-line-fill"></i> <span>Dashboard</span></a></li>
      <li><a href="/hilfe"><i class="bi bi-info-circle-fill"></i> <span>Hilfe</span></a></li>
    </ul>
  </div>

  <!-- Hauptinhalt -->
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
      <h1><i class="bi bi-bookmark-check-fill"></i> Gespeicherte Vokabeln</h1>

      <div class="d-flex gap-2 flex-wrap">
        <select class="form-select" id="languageFilter" onchange="loadVocab()">
          <option value="">🌍 Alle Sprachen</option>
          <option value="en">🇬🇧 Englisch</option>
          <option value="fr">🇫🇷 Französisch</option>
          <option value="es">🇪🇸 Spanisch</option>
          <option value="ja">🇯🇵 Japanisch</option>
          <option value="de">🇩🇪 Deutsch</option>
        </select>

        <button class="btn btn-danger" onclick="deleteAllVocab()">
          <i class="bi bi-trash3-fill"></i> Alle löschen
        </button>
      </div>
    </div>

    <!-- Suchleiste -->
    <div class="input-group mb-3 search-bar">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" class="form-control" placeholder="🔍 Nach Wort oder Satz suchen..." id="searchInput" oninput="handleSearchInput()" autocomplete="off" />
      <div id="suggestionBox" class="list-group"></div>
    </div>

    <!-- Vokabelliste -->
    <ul id="vocabList" class="list-group"></ul>
  </div>

  <!-- JavaScript -->
  <script>
    function handleSearchInput() {
      fetchSuggestions();
      loadVocab();
    }

    function fetchSuggestions() {
      const query = document.getElementById("searchInput").value.trim();
      const suggestionBox = document.getElementById("suggestionBox");

      if (query.length < 2) {
        suggestionBox.innerHTML = "";
        return;
      }

      fetch(`/suggest-vocab?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(suggestions => {
          suggestionBox.innerHTML = "";
          suggestions.forEach(text => {
            const item = document.createElement("div");
            item.className = "list-group-item";
            item.innerHTML = `<i class="bi bi-search text-muted me-2"></i> ${text}`;
            item.onclick = () => {
              document.getElementById("searchInput").value = text;
              suggestionBox.innerHTML = "";
              loadVocab();
            };
            suggestionBox.appendChild(item);
          });
        });
    }

    function loadVocab() {
      const query = document.getElementById("searchInput").value.trim();
      const lang = document.getElementById("languageFilter").value;

      let url = query
        ? `/search-vocab?q=${encodeURIComponent(query)}&lang=${encodeURIComponent(lang)}`
        : `/get-vocab-by-lang?lang=${encodeURIComponent(lang)}`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          renderVocabList(data);
        });
    }

    function renderVocabList(data) {
      const list = document.getElementById("vocabList");
      list.innerHTML = "";

      if (data.length === 0) {
        list.innerHTML = '<li class="list-group-item text-muted">🔍 Keine passenden Vokabeln gefunden.</li>';
        return;
      }

      data.forEach(entry => {
        const item = document.createElement("li");
        item.className = "list-group-item";

        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center flex-wrap">
              <h5 class="mb-0">
                <strong>${entry.original_word}</strong> (${entry.source_lang}) → <strong>${entry.translated_word}</strong> (${entry.target_lang})
                <i class="bi bi-volume-up-fill text-primary fs-5 ms-2" title="Aussprache abspielen" onclick="playTTS('${entry.translated_word}')"></i>
              </h5>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteVocab(${entry.id}, this)" title="Löschen">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        `;

        list.appendChild(item);
      });
    }

    function playTTS(text) {
      fetch("/tts", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ text })
      })
      .then(response => {
        if (!response.ok) throw new Error("TTS fehlgeschlagen");
        return response.blob();
      })
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const audio = new Audio(url);
        audio.play();
      })
      .catch(error => {
        alert("❌ Fehler beim Abspielen: " + error.message);
        console.error(error);
      });
    }

    function deleteVocab(id, button) {
      if (!confirm("Diese Vokabel wirklich löschen?")) return;

      fetch(`/delete-vocab/${id}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            const listItem = button.closest("li");
            if (listItem) listItem.remove();
          } else {
            alert("❌ Fehler beim Löschen: " + data.message);
          }
        })
        .catch(err => {
          alert("❌ Netzwerkfehler beim Löschen.");
          console.error(err);
        });
    }

    function deleteAllVocab() {
      if (!confirm("⚠️ Möchtest du wirklich alle Vokabeln löschen?")) return;

      fetch("/delete-all-vocab", { method: "DELETE" })
        .then(res => res.json())
        .then(data => {
          if (data.status === "success") {
            document.getElementById("vocabList").innerHTML = "";
            alert("✅ Alle Vokabeln wurden gelöscht.");
          } else {
            alert("❌ Fehler: " + data.message);
          }
        })
        .catch(err => {
          alert("❌ Netzwerkfehler beim Löschen.");
          console.error(err);
        });
    }

    loadVocab();

    document.addEventListener("click", function (event) {
      const suggestionBox = document.getElementById("suggestionBox");
      const searchInput = document.getElementById("searchInput");
    
      // Prüfen, ob der Klick innerhalb der Box oder des Inputs war
      if (!suggestionBox.contains(event.target) && !searchInput.contains(event.target)) {
        suggestionBox.innerHTML = "";
      }
    });
  </script>

  <!-- Sidebar-Toggle Script -->
  <script>
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const container = document.querySelector('.container');

    // Zustand beim Laden wiederherstellen
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
      sidebar.classList.add('collapsed');
      container.classList.add('collapsed');
    }

    // Klick: Zustand umschalten und speichern
    toggleBtn.addEventListener('click', function (e) {
      e.preventDefault();
      sidebar.classList.toggle('collapsed');
      container.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });
  </script>

</body>
</html>