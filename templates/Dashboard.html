<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Vokabel-Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
    }
    #languageSelectLabel {
      margin-bottom: 2px !important;
    }
    .chart-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 30px;
      height: 350px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;  /* 👈 NICHT mehr auseinanderziehen */
    }

    .chart-card label {
      margin-bottom: 2px !important;
    }
    canvas {
      max-height: 300px;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <ul>
      <li>
        <a href="#" id="toggleSidebar" class="nav-link">
          <i class="bi bi-list toggle-btn"></i> <span>Navigation</span>
        </a>
      </li>
      <li><a href="/"><i class="bi bi-house-door-fill"></i> <span>Home</span></a></li>
      <li><a href="/favorite"><i class="bi bi-star-fill"></i> <span>Vokabeln</span></a></li>
      <li><a href="/quiz"><i class="bi bi-patch-question-fill"></i> <span>Vokabeltest</span></a></li>
      <li><a href="/lernen"><i class="bi bi-book-half"></i> <span>Lernen</span></a></li>
      <li><a href="/dashboard" class="active"><i class="bi bi-bar-chart-line-fill"></i> <span>Dashboard</span></a></li>
      <li><a href="/hilfe"><i class="bi bi-info-circle-fill"></i> <span>Hilfe</span></a></li>
    </ul>
  </div>

  <!-- Dashboard-Inhalt -->
  <div class="container mt-5">
    <h1 class="text-center mb-5"><i class="bi bi-graph-up-arrow"></i> Lernfortschritt</h1>

    <!-- KPI-Karten -->
    <div class="row text-center mb-5">
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5><i class="bi bi-check2-square text-primary"></i><br>Durchgeführte Tests</h5>
          <h2 id="kpi-tests">–</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5><i class="bi bi-bookmark-fill text-success"></i><br>Gespeicherte Vokabeln</h5>
          <h2 id="kpi-vocab">–</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5><i class="bi bi-bar-chart-fill text-warning"></i><br>Ø Bewertung</h5>
          <h2 id="kpi-avg">–</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card shadow-sm p-3">
          <h5><i class="bi bi-clock-history text-info"></i><br>Letzter Test</h5>
          <h2 id="kpi-last">–</h2>
        </div>
      </div>
    </div>

    <!-- Diagramme -->
    <div class="row justify-content-center">
      <!-- Balkendiagramm -->
      <div class="col-md-6">
        <div class="chart-card">
          <canvas id="langChart"></canvas>
        </div>
      </div>

      <!-- Kreisdiagramm -->
      <div class="col-md-6">
        <div class="chart-card">
          <canvas id="resultChart"></canvas>
        </div>
      </div>

      <!-- Lernaktivität -->
      <div class="col-md-6">
        <div class="chart-card">
          <canvas id="activityChart"></canvas>
        </div>
      </div>

      <div class="col-md-6">
        <div class="chart-card">
          <div class="text-center mb-4" style="font-size: 12px; font-weight: 600; color: #6c757d;">
            Sprachniveau je Sprache
          </div>
          <div style="margin-bottom: 10px; font-weight: 500; font-size: 0.95rem;"><strong>Sprache auswählen:</strong></div>
          <select id="languageSelect" class="form-select mb-2"></select>

          
          <p class="mt-4"><strong>Aktuelles Niveau:</strong> <span id="currentLevel">–</span></p>
          <p><Fehlende Wörter> <span id="remainingWords">–</span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Sidebar Toggle Script -->
  <script>
    const toggleBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const container = document.querySelector('.container');

    // Zustand beim Laden wiederherstellen
    if (localStorage.getItem('sidebarCollapsed') === 'true') {
      sidebar.classList.add('collapsed');
      container.classList.add('collapsed');
    }

    // Klick: Zustand umschalten und speichern
    toggleBtn.addEventListener('click', function (e) {
      e.preventDefault();
      sidebar.classList.toggle('collapsed');
      container.classList.toggle('collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    });
  </script>

  <script>
    // 📊 KPI-Daten laden
    fetch("/dashboard-kpis")
      .then(res => res.json())
      .then(data => {
        document.getElementById("kpi-tests").innerText = data.total_tests;
        document.getElementById("kpi-vocab").innerText = data.total_vocab;
        document.getElementById("kpi-avg").innerText = data.avg_score + " %";
        document.getElementById("kpi-last").innerText = data.last_score + " %";
      })
      .catch(err => console.error("❌ Fehler beim Laden der KPIs:", err));

    // 📊 Vokabeln pro Sprache (Bar)
    fetch("/vocab-language-stats")
      .then(res => res.json())
      .then(data => {
        const ctx = document.getElementById("langChart").getContext("2d");
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels.map(lang => lang.toUpperCase()),
            datasets: [{
              label: 'Gespeicherte Vokabeln pro Sprache',
              data: data.counts,
              backgroundColor: '#4e79a7'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: 'Vokabelanzahl pro Sprache'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 }
              }
            }
          }
        });
      });

    // ✅ Testergebnisse (Doughnut)
    fetch("/quiz-result-summary")
      .then(res => res.json())
      .then(data => {
        if (data.passed + data.failed === 0) {
          document.getElementById("resultChart").parentElement.innerHTML =
            '<div class="alert alert-warning text-center">Noch keine Testergebnisse vorhanden.</div>';
          return;
        }

        const ctx = document.getElementById("resultChart").getContext("2d");
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Bestanden', 'Nicht bestanden'],
            datasets: [{
              data: [data.passed, data.failed],
              backgroundColor: ['#28a745', '#dc3545']
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'bottom' },
              title: {
                display: true,
                text: 'Testergebnisse: Bestanden vs. Nicht bestanden'
              }
            }
          }
        });
      });

    // 📅 Lernaktivität über Zeit (Line)
    fetch("/learning-activity-over-time")
      .then(res => res.json())
      .then(data => {
        const ctx = document.getElementById("activityChart").getContext("2d");
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.labels,
            datasets: [{
              label: 'Gelernte Vokabeln pro Tag',
              data: data.counts,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: {
                display: true,
                text: 'Lernaktivität (alle Sprachen)'
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });

    fetch("/language-level-stats")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById("languageSelect");
        const level = document.getElementById("currentLevel");
        const remaining = document.getElementById("remainingWords");

        // Dropdown-Optionen erzeugen
        data.forEach(entry => {
          const option = document.createElement("option");
          option.value = entry.language;
          option.text = entry.language.toUpperCase();
          select.appendChild(option);
        });

        // Anzeige initialisieren
        function updateDisplay(language) {
          const selected = data.find(e => e.language === language);
          level.innerText = selected.level;
          let nextLevel = "–";
          const levelOrder = ["-", "A1", "A2", "B1", "B2", "C1", "C2"];
          const currentIndex = levelOrder.indexOf(selected.level);
          if (currentIndex >= 0 && currentIndex < levelOrder.length - 1) {
            nextLevel = levelOrder[currentIndex + 1];
          }
          if (selected.remaining > 0) {
            remaining.innerHTML = `Fehlende Vokabeln bis <strong>Niveau ${nextLevel}</strong>: ${selected.remaining}`;
          } else {
            remaining.innerHTML = `<strong>🎉 Maximales Niveau erreicht</strong>`;
          }
        }

        // Beim Wechsel aktualisieren
        select.addEventListener("change", () => {
          updateDisplay(select.value);
        });

        // Erste Option vorauswählen
        if (data.length > 0) {
          select.value = data[0].language;
          updateDisplay(data[0].language);
        }
      });


  </script>
</body>
</html>