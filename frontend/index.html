<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>√úbersetzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <div class="sidebar">
        <h2><i class="bi bi-list-stars"></i> Navigation</h2>
        <ul>
            <li><a href="index.html" class="active"><i class="bi bi-house-door-fill"></i> Home</a></li>
            <li><a href="favorite.html"><i class="bi bi-star-fill"></i> Vokabeln</a></li>
            <li><a href="quiz.html"><i class="bi bi-patch-question-fill"></i> Vokabeltest</a></li>
        </ul>
    </div>

    <div class="container">
        <h1 class="text-center">
            <i class="bi bi-translate"></i> √úbersetzer
        </h1>          
        <div class="lang-select" style="display: flex; justify-content: space-between;">
            <!-- Linke Spalte: erkannte Sprache -->
            <div style="flex: 1;">
                <label for="sourceLang">Erkannte Sprache:</label>
                <select id="sourceLang">
                    <option value="de-DE">Deutsch</option>
                    <option value="en-US">Englisch</option>
                    <option value="fr-FR">Franz√∂sisch</option>
                    <option value="es-ES">Spanisch</option>
                    <option value="ja-JP">Japanisch</option>
                    <option value="it-IT">Italienisch</option>
                    <option value="pt-PT">Portugiesisch</option>
                    <option value="el-GR">Griechisch</option>
                    <option value="nl-NL">Niederl√§ndisch</option>
                    <option value="sv-SE">Schwedisch</option>
                    <option value="no-NO">Norwegisch</option>
                    <option value="da-DK">D√§nisch</option>
                    <option value="fi-FI">Finnisch</option>
                    <option value="pl-PL">Polnisch</option>
                    <option value="cs-CZ">Tschechisch</option>
                    <option value="sk-SK">Slowakisch</option>
                    <option value="hu-HU">Ungarisch</option>
                    <option value="ro-RO">Rum√§nisch</option>
                    <option value="bg-BG">Bulgarisch</option>
                    <option value="sr-RS">Serbisch</option>
                    <option value="hr-HR">Kroatisch</option>
                    <option value="sq-AL">Albanisch</option>
                    <option value="ru-RU">Russisch</option>
                    <option value="uk-UA">Ukrainisch</option>
                </select>
            </div>

            <button onclick="swapLanguagesAndText()" style="font-size: 22px; border: none; background: none; cursor: pointer;">
                <i class="bi bi-arrow-left-right"></i>
            </button>

            <!-- Rechte Spalte: Ziel-Sprache, rechtsb√ºndig -->
            <div style="flex: 1; text-align: right;">
                <label for="targetLang">Zielsprache ausw√§hlen:</label>
                <select id="targetLang">
                    <option value="en-US">Englisch</option>
                    <option value="de-DE">Deutsch</option>
                    <option value="fr-FR">Franz√∂sisch</option>
                    <option value="es-ES">Spanisch</option>
                    <option value="ja-JP">Japanisch</option>
                    <option value="it-IT">Italienisch</option>
                    <option value="pt-PT">Portugiesisch</option>
                    <option value="el-GR">Griechisch</option>
                    <option value="nl-NL">Niederl√§ndisch</option>
                    <option value="sv-SE">Schwedisch</option>
                    <option value="no-NO">Norwegisch</option>
                    <option value="da-DK">D√§nisch</option>
                    <option value="fi-FI">Finnisch</option>
                    <option value="pl-PL">Polnisch</option>
                    <option value="cs-CZ">Tschechisch</option>
                    <option value="sk-SK">Slowakisch</option>
                    <option value="hu-HU">Ungarisch</option>
                    <option value="ro-RO">Rum√§nisch</option>
                    <option value="bg-BG">Bulgarisch</option>
                    <option value="sr-RS">Serbisch</option>
                    <option value="hr-HR">Kroatisch</option>
                    <option value="sq-AL">Albanisch</option>
                    <option value="ru-RU">Russisch</option>
                    <option value="uk-UA">Ukrainisch</option>
                </select>
            </div>
        </div>
        <div class="translator-boxes">
            <!-- Eingabetext + Mikrofon -->
            <div class="text-box-wrapper">
                <div id="inputText" contenteditable="true" class="text-box" onmouseup="handleSelection('lang1')"></div>
                <button class="mic-button" onclick="toggleRecording()" id="micBtn">
                    <i class="bi bi-mic-fill"></i>
                </button>
                <!-- Lautsprecher (Eingabetext) -->
                <button class="speaker-button" id="inputSpeaker" onclick="speakInputText()" style="left: 40px;">
                    <i class="bi bi-volume-up-fill"></i>
                </button>
                <!-- Lerntext Generator -->
                <div class="generate-wrapper">
                    <button class="generate-button" id="generateDropdownBtn" title="Lerntext generieren">
                        <i class="bi bi-stars"></i>
                    </button>
                    <div class="generate-tooltip" id="generateTooltip">
                        <div onclick="generateLearningText('easy')">
                            <span class="circle easy"></span> Einfach
                        </div>
                        <div onclick="generateLearningText('medium')">
                            <span class="circle medium"></span> Mittel
                        </div>
                        <div onclick="generateLearningText('hard')">
                            <span class="circle hard"></span> Schwer
                        </div>
                    </div>
                    
                </div>
            </div>

            <!-- √úbersetzungstext + Lautsprecher + L√ºckentext -->
            <div class="text-box-wrapper">
                <div id="outputText" contenteditable="false" class="text-box" onmouseup="handleSelection('lang2')"></div>
                <!-- Lautsprecher (Zieltext) -->
                <button class="speaker-button" id="outputSpeaker" onclick="speakText()">
                    <i class="bi bi-volume-up-fill"></i>
                </button>
                <!-- L√ºckentext erstellen -->
                <button class="speaker-button" style="left: 40px;" onclick="generateGapFromOutput()">
                    <i class="bi bi-pencil-fill"></i>
                </button>
            </div>
        </div>

        <!-- Reset-Button f√ºr Markierungen -->
        <div style="text-align: center; margin-top: 10px;">
            <button onclick="clearHighlights()" style="padding: 8px 12px; font-size: 16px; border-radius: 6px; border: none; background-color: #eee; cursor: pointer;">
                üîÑ Markierungen zur√ºcksetzen
            </button>
        </div>

        <!-- Erkl√§rungsbox f√ºr Wortbedeutung -->
        <div id="explanationBox" style="display: none;"></div>
    </div>
    <div id="saveVocabWrapper" class="text-center mt-4" style="display: none;">
        <button onclick="saveVocabEntry()" class="btn btn-warning">
            ‚≠ê Zur Vokabelliste hinzuf√ºgen
        </button>
    </div>

    <script>
        let lastMatchedWord = null;
        let lastInputText = "";
        let lastOutputText = "";
        let translateTimer;
        
        document.getElementById("inputText").addEventListener("input", () => {
            const text = document.getElementById("inputText").innerText.trim();
            const fullTargetLang = document.getElementById("targetLang").value;
            const targetLang = fullTargetLang.split("-")[0];
        
            clearTimeout(translateTimer);
        
            if (text.length > 0) {
                translateTimer = setTimeout(() => {
                    fetch("http://127.0.0.1:5000/translate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text: text, target_lang: targetLang })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.translated) {
                            lastInputText = text;
        
                            const outputField = document.getElementById("outputText");
                            outputField.innerText = "";
        
                            if (typeof data.translated === "object" && data.translated.translated) {
                                lastOutputText = data.translated.translated;
                                outputField.innerText = data.translated.translated;
                            } else {
                                lastOutputText = data.translated;
                                outputField.innerText = data.translated;
                            }
                        }
                    })
                    .catch(err => console.error("Fehler:", err));
                }, 500);
            }
        });
        
        function clearHighlights() {
            ["inputText", "outputText"].forEach(id => {
                const el = document.getElementById(id);
        
                el.innerHTML = el.innerHTML
                    .replace(/<span[^>]*class="[^"]*highlight[^"]*"[^>]*>(.*?)<\/span>/g, '$1')
                    .replace(/<span[^>]*class="[^"]*info-icon[^"]*"[^>]*>.*?<\/span>/g, '');
            });
        
            document.getElementById("explanationBox").style.display = "none";
            document.getElementById("explanationBox").innerHTML = "";
        
            if (typeof highlightColorMap !== "undefined") highlightColorMap.length = 0;
            if (typeof highlightIndex !== "undefined") highlightIndex = 0;
        }
        
        const highlightColorMap = [];
        
        function removeAccents(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        
        const shownIcons = {
            inputText: {},
            outputText: {}
        };
        function highlightWord(containerId, word, colorIndex) {
    const el = document.getElementById(containerId);
    if (!el || !word) return;

    const color = highlightColors[colorIndex % highlightColors.length];
    const regex = new RegExp(`\\b(${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})\\b`, "gi");

    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
    const textNodes = [];

    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
        if (node.parentNode && node.parentNode.classList.contains("highlight")) return;

        const text = node.textContent;
        const parts = text.split(regex);
        if (parts.length <= 1) return;

        const fragment = document.createDocumentFragment();

        parts.forEach((part, i) => {
            if (i % 2 === 0) {
                fragment.appendChild(document.createTextNode(part));
            } else {
                const highlight = document.createElement("span");
                highlight.className = "highlight";
                highlight.style.backgroundColor = color;
                highlight.style.color = "black";
                highlight.textContent = part;

                const wrapper = document.createElement("span");
                wrapper.appendChild(highlight);

                if (!node.markedOnce) {
                    const infoIcon = document.createElement("span");
                    infoIcon.className = "info-icon";
                    infoIcon.textContent = " ‚ÑπÔ∏è";
                    infoIcon.onclick = () => fetchExplanation(part);
                    wrapper.appendChild(infoIcon);
                    node.markedOnce = true;
                }

                fragment.appendChild(wrapper);
            }
        });

        node.parentNode.replaceChild(fragment, node);
    });
}

function highlightPhrase(containerId, phrase, colorIndex) {
    const container = document.getElementById(containerId);
    if (!container || !phrase) return;

    const color = highlightColors[colorIndex % highlightColors.length];
    const normalizedPhrase = phrase.trim().toLowerCase();

    const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
    let found = false;

    while (walker.nextNode()) {
        const node = walker.currentNode;
        const originalText = node.textContent;
        const normalizedText = originalText.toLowerCase();

        const index = normalizedText.indexOf(normalizedPhrase);
        if (index === -1) continue;

        const before = document.createTextNode(originalText.slice(0, index));
        const match = document.createElement("span");
        match.className = "highlight";
        match.style.backgroundColor = color;
        match.style.color = "black";
        match.textContent = originalText.slice(index, index + phrase.length);

        const icon = document.createElement("span");
        icon.className = "info-icon";
        icon.textContent = " ‚ÑπÔ∏è";
        icon.onclick = () => fetchExplanation(phrase);

        const after = document.createTextNode(originalText.slice(index + phrase.length));

        const wrapper = document.createElement("span");
        wrapper.appendChild(before);
        wrapper.appendChild(match);
        wrapper.appendChild(icon);
        wrapper.appendChild(after);

        node.parentNode.replaceChild(wrapper, node);
        found = true;
        break;
    }
}

function addHighlight(containerId, word) {
    const container = document.getElementById(containerId);
    if (!container || !word) return;

    const normalizedTarget = removeAccents(word.toLowerCase());
    console.log("üîç Zu markierendes Wort (ohne Akzente):", normalizedTarget);

    const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
    const textNodes = [];

    while (walker.nextNode()) {
        textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
        const parts = node.textContent.split(/(\b[\w\u00C0-\u017F]+\b)/);
        const replaced = parts.map(part => {
            const partNorm = removeAccents(part.toLowerCase());

            console.log(`üîé Vergleiche: "${part}" ‚Üí "${partNorm}" vs "${normalizedTarget}"`);

            if (partNorm === normalizedTarget) {
                return `<span class="highlight">${part}</span>`;
            }
            return part;
        });

        const joined = replaced.join("");
        if (joined !== node.textContent) {
            const span = document.createElement("span");
            span.innerHTML = joined;
            node.parentNode.replaceChild(span, node);
        }
    });
}

let highlightIndex = 0;
const highlightColors = [
    "#ffd500",
    "#39FF14",
    "#a200ff",
    "#00bfff",
    "#ff2b2b"
];

function handleSelection(lang) {
    const sel = window.getSelection();
    const word = sel.toString().trim();
    if (!word || word.includes(" ")) return;

    const payload = {
        sentence1: lastInputText,
        sentence2: lastOutputText,
        selectedWord: word,
        selectedFrom: lang,
        sourceLangCode: document.getElementById("sourceLang").value,
        targetLangCode: document.getElementById("targetLang").value
    };

    fetch("http://127.0.0.1:5000/match-word", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
})
.then(res => res.json())
.then(data => {
    if (!data || data.error) {
        console.error("Fehler beim Matching:", data?.error);
        return;
    }

    console.log("üîç Translated Matches:", data.translatedMatches);

    const colorIndex = highlightIndex;

    const originalMatches = data.originalMatches || [];
    const translatedMatches = data.translatedMatches || [];

    if (lang === "lang1") {
        originalMatches.forEach(w => highlightWord("inputText", w, colorIndex));
        translatedMatches.forEach(w => highlightWord("outputText", w, colorIndex));
    } else {
        translatedMatches.forEach(w => highlightWord("outputText", w, colorIndex));
        originalMatches.forEach(w => highlightWord("inputText", w, colorIndex));
    }

    highlightIndex++;

    // ‚úÖ üîÅ Vokabel f√ºr Speicherung vorbereiten
    lastMatchedWord = {
        original_word: data.selectedWord,  // oder word, wenn du das lokal hast
        translated_word: translatedMatches[0] || "",
        source_lang: document.getElementById("sourceLang").value,
        target_lang: document.getElementById("targetLang").value,
        original_sentence: lastInputText,
        translated_sentence: lastOutputText
    };

    console.log("üíæ Vokabel bereit zum Speichern:", lastMatchedWord);
    document.getElementById("saveVocabWrapper").style.display = "block";
})
.catch(err => console.error("Fehler beim Matching:", err));}


function fetchExplanation(word) {
    const sentence = document.getElementById("outputText").innerText;

    fetch("http://127.0.0.1:5000/explain-word", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sentence: sentence, word: word })
    })
    .then(res => res.json())
    .then(data => {
        const box = document.getElementById("explanationBox");
        box.innerHTML = `<h3>Erkl√§rung zu: ${word}</h3>${data.explanation}`;
        box.style.display = "block";
        window.scrollTo({ top: box.offsetTop - 20, behavior: "smooth" });
    })
    .catch(err => console.error("Fehler bei Erkl√§rung:", err));
}

// üé§ Mikrofon / Aufnahme-Logik
let isRecording = false;
let mediaRecorder;
let audioChunks = [];

function toggleRecording() {
    const micIcon = document.getElementById("micBtn");

    if (!isRecording) {
        isRecording = true;
        micIcon.classList.add("active");

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                    const formData = new FormData();
                    formData.append("audio", audioBlob, "recording.webm");

                    fetch("http://127.0.0.1:5000/transcribe-audio", {
                        method: "POST",
                        body: formData
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.transcription) {
                            const inputBox = document.getElementById("inputText");
                            inputBox.innerText = data.transcription;
                            inputBox.dispatchEvent(new Event("input"));
                        } else {
                            alert("‚ùå Keine Transkription empfangen.");
                        }
                    })
                    .catch(err => console.error("Transkriptionsfehler:", err));
                };

                mediaRecorder.start();
            })
            .catch(err => {
                alert("üé§ Zugriff auf Mikrofon verweigert.");
                console.error(err);
            });
    } else {
        isRecording = false;
        micIcon.classList.remove("active");
        mediaRecorder.stop();
    }
}

function speakText() {
    const text = document.getElementById("outputText").innerText.trim();
    const lang = document.getElementById("targetLang").value;
    const button = document.getElementById("outputSpeaker");

    if (!text) return;

    button.classList.add("speaking");

    fetch("http://127.0.0.1:5000/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text, lang: lang })
    })
    .then(res => {
        if (!res.ok) throw new Error("TTS fehlgeschlagen");
        return res.blob();
    })
    .then(blob => {
        const audioURL = URL.createObjectURL(blob);
        const audio = new Audio(audioURL);
        audio.play();

        audio.onended = () => {
            button.classList.remove("speaking");
        };
    })
    .catch(err => {
        button.classList.remove("speaking");
        console.error("Fehler bei TTS:", err);
    });
}

function swapLanguagesAndText() {
    const sourceSelect = document.getElementById("sourceLang");
    const targetSelect = document.getElementById("targetLang");

    const tempLang = sourceSelect.value;
    sourceSelect.value = targetSelect.value;
    targetSelect.value = tempLang;

    const inputBox = document.getElementById("inputText");
    const outputBox = document.getElementById("outputText");

    const oldInput = inputBox.innerText.trim();
    const oldOutput = outputBox.innerText.trim();

    inputBox.innerText = oldOutput;
    outputBox.innerText = oldInput;

    inputBox.dispatchEvent(new Event("input"));
}
function updateDetectedLanguage(langCode) {
    const dropdown = document.getElementById("sourceLang");
    if (dropdown) dropdown.value = langCode;
}

function speakInputText() {
    const text = document.getElementById("inputText").innerText.trim();
    const lang = document.getElementById("sourceLang").value;
    const button = document.getElementById("inputSpeaker");

    if (!text) return;

    button.classList.add("speaking");

    fetch("http://127.0.0.1:5000/tts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text, lang: lang })
    })
    .then(res => {
        if (!res.ok) throw new Error("TTS fehlgeschlagen");
        return res.blob();
    })
    .then(blob => {
        const audioURL = URL.createObjectURL(blob);
        const audio = new Audio(audioURL);
        audio.play();

        audio.onended = () => {
            button.classList.remove("speaking");
        };
    })
    .catch(err => {
        button.classList.remove("speaking");
        console.error("Fehler bei TTS (input):", err);
    });
}

function generateLearningText(difficulty) {
    const langCode = document.getElementById("sourceLang").value;

    fetch("http://127.0.0.1:5000/generate-text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ language: langCode, difficulty: difficulty })
    })
    .then(res => res.json())
    .then(data => {
        if (data.text) {
            document.getElementById("inputText").innerText = data.text;
            document.getElementById("inputText").dispatchEvent(new Event("input"));
        } else {
            console.error("Fehler: Kein Text erhalten", data);
        }
    })
    .catch(err => console.error("Fehler beim Generieren:", err));
}

const tooltip = document.getElementById("generateTooltip");
const button = document.getElementById("generateDropdownBtn");

button.addEventListener("mouseenter", () => {
    tooltip.style.display = "block";
});

button.addEventListener("mouseleave", () => {
    setTimeout(() => {
        if (!tooltip.matches(':hover')) {
            tooltip.style.display = "none";
        }
    }, 200);
});

tooltip.addEventListener("mouseleave", () => {
    tooltip.style.display = "none";
});

function generateGapFromOutput() {
    const sentence = document.getElementById("outputText").innerText.trim();

    fetch("http://127.0.0.1:5000/gap-fill", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sentence: sentence })
    })
    .then(res => res.json())
    .then(data => {
        const gapText = data.gap_text;
        const originalWord = data.original_word;

        if (!gapText || !originalWord) return;

        const htmlWithGap = gapText.replace(
            "_____",
            `<input class="gap-input" type="text" data-solution="${originalWord}" style="width: 80px;">`
        );
        document.getElementById("outputText").innerHTML = htmlWithGap;
    })
    .catch(err => console.error("Fehler bei L√ºckentext:", err));
}

document.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        const allInputs = document.querySelectorAll(".gap-input");

        allInputs.forEach(input => {
            const userInput = input.value.trim();
            const correctWord = input.dataset.solution?.trim();

            if (!correctWord) return;

            const replacement = `<b>${correctWord}</b>`;

            if (userInput.toLowerCase() === correctWord.toLowerCase()) {
                input.outerHTML = replacement;
                alert("‚úÖ Richtig!");
            } else {
                input.outerHTML = replacement;
                alert(`‚ùå Falsch! Die richtige L√∂sung war: "${correctWord}"`);
            }
        });
    }
});

function saveVocabEntry() {
    console.log("üîÅ saveVocabEntry() wurde aufgerufen");
    if (!lastMatchedWord) return;

    fetch("http://127.0.0.1:5000/save-vocab", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(lastMatchedWord)
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            const list = document.getElementById("vocabEntries");
            if (list) {
                const item = document.createElement("li");
                item.innerHTML = `<b>${lastMatchedWord.original_word}</b> ‚Üí ${lastMatchedWord.translated_word}`;
                list.appendChild(item);
            }

            alert("‚úÖ Vokabel gespeichert!");
        } else {
            alert("‚ùå Fehler beim Speichern: " + (data.message || "Unbekannter Fehler"));
            console.error("Antwort vom Server:", data);
        }

        document.getElementById("saveVocabWrapper").style.display = "none";
        lastMatchedWord = null;
    })
    .catch(err => {
        alert("‚ùå Netzwerk-/Speicherfehler: " + err.message);
        console.error("Fehler beim Speichern:", err);
    });
}

</script>
</body>
</html>