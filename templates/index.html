<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Übersetzer - Vokabeltrainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Kein externen styles.css Link, alles inline -->
    <style>
        :root {
            --apple-font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            --primary-text-color: #1d1d1f;
            --secondary-text-color: #6e6e73;
            --background-body-color: #f5f5f7;
            --background-content-color: #ffffff;
            --border-color-light: #e5e5e7;
            --accent-color-blue: #007aff;
            --accent-color-red: #ff3b30;
            --accent-color-green: #34c759;   
            --accent-color-yellow: #ffcc00;
            --radius-large: 18px;
            --radius-medium: 12px;
            --radius-small: 8px;
            --shadow-card: 0 5px 20px rgba(0,0,0,0.07);
        }
        body {
          font-family: var(--apple-font);
          background-color: var(--background-body-color);
          color: var(--primary-text-color);
          margin: 0;
          display: flex;
        }
        /* --- Sidebar Styles (kopiert & angepasst) --- */
        .sidebar {
            width: 250px; min-width: 250px; height: 100vh; position: fixed; left: 0; top: 0;
            background-color: var(--background-content-color); border-right: 1px solid var(--border-color-light);
            padding: 1.5rem 0; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1030; display: flex; flex-direction: column; overflow-x: hidden;
        }
        .sidebar.collapsed { width: 75px; min-width: 75px; }
        .sidebar ul { list-style-type: none; padding: 0 1rem; margin: 0; flex-grow: 1; }
        .sidebar ul li a {
            display: flex; align-items: center; padding: 12px 15px; margin-bottom: 6px;
            text-decoration: none; color: var(--primary-text-color); font-weight: 500;
            border-radius: var(--radius-medium); transition: background-color 0.15s ease-out, color 0.15s ease-out;
            white-space: nowrap;
        }
        .sidebar ul li a .bi {
            margin-right: 16px; font-size: 1.3rem; min-width: 28px; text-align: center;
            color: var(--secondary-text-color); transition: color 0.15s ease-out;
        }
        .sidebar.collapsed ul li a .bi { margin-right: 0; }
        .sidebar ul li a:hover { background-color: #f0f0f2; }
        .sidebar ul li a.active { background-color: var(--accent-color-blue); color: white; }
        .sidebar ul li a.active .bi { color: white; }
        .sidebar .sidebar-text { opacity: 1; transition: opacity 0.1s ease-out 0.05s; }
        .sidebar.collapsed .sidebar-text { opacity: 0; pointer-events: none; display: none; }
        .sidebar-footer { padding: 1rem 1.5rem; margin-top: auto; border-top: 1px solid var(--border-color-light); }
        .btn-logout-sidebar {
            display: flex; align-items: center; width: 100%; padding: 10px 15px;
            background-color: transparent; color: var(--accent-color-red);
            border: 1px solid transparent; border-radius: var(--radius-medium);
            font-weight: 500; text-align: left; transition: background-color 0.15s ease-out, border-color 0.15s ease-out;
            cursor: pointer; text-decoration: none; /* Wichtig für a-Tag */
        }
        .btn-logout-sidebar:hover { background-color: rgba(255, 59, 48, 0.1); border-color: rgba(255, 59, 48, 0.2); }
        .btn-logout-sidebar .bi { margin-right: 16px; font-size: 1.3rem; }
        .sidebar.collapsed .btn-logout-sidebar { justify-content: center; padding: 10px; }
        .sidebar.collapsed .btn-logout-sidebar .sidebar-text { display: none; }
        .sidebar.collapsed .btn-logout-sidebar .bi { margin-right: 0; }

        /* --- Hauptinhaltsbereich Styles --- */
        .main-content-wrapper {
            margin-left: 250px; padding: 2.5rem; width: calc(100% - 250px);
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100vh; overflow-y: auto;
        }
        .main-content-wrapper.collapsed { margin-left: 75px; width: calc(100% - 75px); }

        .page-header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color-light);
        }
        .page-header-bar h1 {
            font-size: 2rem; font-weight: 600; margin: 0; display: flex; align-items: center;
        }
        .page-header-bar h1 .bi { margin-right: 0.8rem; color: var(--accent-color-blue); font-size: 1.7rem;}

        /* Spezifische Styles für index.html (Übersetzer) */
        .lang-select-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; padding: 0.75rem 0; /* Kein extra Hintergrund/Schatten */
        }
        .lang-select-bar .lang-group { flex: 1; }
        .lang-select-bar .lang-group:last-child { text-align: right; }
        .lang-select-bar label {
            font-size: 0.8rem; color: var(--secondary-text-color); margin-bottom: 0.25rem; display: block;
        }
        .lang-select-bar .form-select {
            width: auto; /* Breite an Inhalt anpassen */
            min-width: 180px; max-width: 220px; /* Begrenzungen */
            display: inline-block; /* Für korrekte Breitenanpassung */
            font-size: 0.9rem; padding: 8px 12px;
            border-radius: var(--radius-s); border: 1px solid var(--border-color-light);
            background-color: var(--background-content-color); box-shadow: none;
        }
        .lang-select-bar .form-select:focus {
             border-color: var(--accent-color-blue); box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        .swap-button {
            background: none; border: none; font-size: 1.4rem; color: var(--secondary-text-color);
            cursor: pointer; padding: 0.5rem; margin: 0 1rem; /* Abstand zu den Selects */
            line-height: 1; transition: color 0.2s ease, transform 0.2s ease;
        }
        .swap-button:hover { color: var(--accent-color-blue); transform: scale(1.1); }

        .translator-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;
        }
        .text-box-wrapper { position: relative; display: flex; flex-direction: column;
            background-color: var(--background-content-color);
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color-light);
            overflow: hidden; /* Wichtig, damit Toolbar nicht überlappt */
        }
        .text-box { /* contenteditable div */
            width: 100%; flex-grow: 1;
            min-height: 250px; /* Mindesthöhe */
            padding: 1.25rem; font-size: 1.05rem; line-height: 1.65;
            overflow-y: auto; outline: none;
        }
        .text-box[placeholder]:empty:before {
            content: attr(placeholder); color: var(--secondary-text-color);
            pointer-events: none; display: block; opacity: 0.7;
        }

        .box-actions-toolbar {
            display: flex; align-items: center; gap: 0.25rem; /* Kleinerer Gap */
            padding: 0.5rem 0.75rem;
            background-color: rgba(248, 248, 250, 0.85); /* Leicht anderer Hintergrund */
            backdrop-filter: blur(5px);
            border-top: 1px solid var(--border-color-light);
        }
        .box-actions-toolbar .btn-icon {
            background: none; border: none; color: var(--secondary-text-color);
            border-radius: var(--radius-small); width: 34px; height: 34px; /* Etwas kleiner */
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 1.05rem; transition: background-color 0.15s ease, color 0.15s ease;
        }
        .box-actions-toolbar .btn-icon:hover { background-color: #e0e0e5; color: var(--primary-text-color); }
        .box-actions-toolbar .mic-button.active i { color: var(--accent-color-red); }
        
        .generate-wrapper { position: relative; margin-left: auto; } /* Schiebt den Stern nach rechts */
        .generate-tooltip {
            display: none; position: absolute; bottom: calc(100% + 8px); right: 0; /* Angepasste Position */
            background-color: var(--background-content-color); border: 1px solid var(--border-color-light);
            border-radius: var(--radius-medium); padding: 0.5rem;
            box-shadow: 0 6px 15px rgba(0,0,0,0.12); z-index: 10; min-width: 160px;
        }
        .generate-tooltip div { padding: 6px 10px; cursor: pointer; display: flex; align-items: center; border-radius:var(--radius-small); font-size:0.9rem;}
        .generate-tooltip div:hover { background-color: #f0f0f2; }
        .generate-tooltip .circle { width: 9px; height: 9px; border-radius: 50%; margin-right: 8px; display: inline-block; }
        .generate-tooltip .easy { background-color: var(--accent-color-green); }
        .generate-tooltip .medium { background-color: var(--accent-color-yellow); }
        .generate-tooltip .hard { background-color: var(--accent-color-red); }

        .centered-action-buttons { /* Für "Markierungen zurücksetzen" und "Speichern" */
            display: flex; justify-content: center; gap: 1rem;
            margin-top: 1.5rem; margin-bottom: 1.5rem;
        }
        .btn-apple-style { /* Allgemeiner Apple Button Stil */
            background-color: #e9e9eb; color: var(--primary-text-color); border: none;
            padding: 10px 20px; border-radius: var(--radius-medium); font-weight: 500;
            cursor: pointer; transition: background-color 0.15s ease-in-out;
            display: inline-flex; align-items: center; justify-content: center; font-size: 0.95rem;
        }
        .btn-apple-style:hover { background-color: #dcdce0; }
        .btn-apple-style.primary { background-color: var(--accent-color-blue); color: white; }
        .btn-apple-style.primary:hover { background-color: #0056b3; }
        .btn-apple-style .bi { margin-right: 0.5rem; }

        #explanationBox {
            margin-top: 1.5rem; padding: 1.5rem; background-color: var(--background-content-color);
            border-radius: var(--radius-large); box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color-light);
        }
        #explanationBox h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--primary-text-color);}
        #explanationBox p { font-size: 0.95rem; color: var(--secondary-text-color); line-height: 1.6;}
        #explanationBox strong { color: var(--primary-text-color); font-weight: 600;}

        .highlight { background-color: rgba(255, 220, 0, 0.6); padding: 0.05em 0.15em; border-radius: 3px; }
        .info-icon { cursor: pointer; margin-left: 2px; font-size: 0.8em; color: var(--accent-color-blue); display: inline-block; vertical-align: super;}
        .info-icon:hover { opacity: 0.7; }
        .gap-input {
            border: 1px dashed var(--accent-color-blue); text-align: center; border-radius: var(--radius-small);
            padding: 3px 5px; margin: 0 3px; width: auto; min-width: 70px; font-size: 1em;
            background-color: rgba(0,122,255,0.05);
        }
        .gap-input:focus { outline: 1px solid var(--accent-color-blue); }
  </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <ul>
          <li><a href="#" id="toggleSidebar"><i class="bi bi-list"></i> <span class="sidebar-text">Navigation</span></a></li>
          <li><a href="{{ url_for('index') }}" class="active"><i class="bi bi-translate"></i> <span class="sidebar-text">Übersetzer</span></a></li>
          {% if current_user.is_authenticated %}
          <li><a href="{{ url_for('favorite') }}"><i class="bi bi-star"></i> <span class="sidebar-text">Vokabeln</span></a></li>
          <li><a href="{{ url_for('quiz_page') }}"><i class="bi bi-clipboard-check"></i> <span class="sidebar-text">Vokabeltest</span></a></li>
          <li><a href="{{ url_for('lernen') }}"><i class="bi bi-book"></i> <span class="sidebar-text">Lernen</span></a></li>
          <li><a href="{{ url_for('dashboard') }}"><i class="bi bi-grid-1x2"></i> <span class="sidebar-text">Dashboard</span></a></li>
          {% endif %}
          <li><a href="{{ url_for('hilfe') }}"><i class="bi bi-question-circle"></i> <span class="sidebar-text">Hilfe</span></a></li>
           <li class="mt-auto pt-3 border-top sidebar-bottom-links">
            {% if current_user.is_authenticated %}
                <a href="#" class="disabled-link"><i class="bi bi-person-circle"></i> <span class="sidebar-text">{{ current_user.username }}</span></a>
                <a href="{{ url_for('logout') }}" id="logoutButtonSidebar" class="btn-logout-sidebar">
                    <i class="bi bi-box-arrow-left"></i><span class="sidebar-text">Logout</span>
                </a>
            {% else %}
                <a href="{{ url_for('login') }}"><i class="bi bi-box-arrow-in-right"></i> <span class="sidebar-text">Login</span></a>
                <a href="{{ url_for('register') }}"><i class="bi bi-person-plus"></i> <span class="sidebar-text">Registrieren</span></a>
            {% endif %}
            </li>
        </ul>
    </nav>

    <main class="main-content-wrapper" id="mainContent">
      <div class="container-fluid no-padding"> <!-- Volle Breite innerhalb des Wrappers -->
        <header class="page-header-bar">
            <h1><i class="bi bi-translate"></i>Textübersetzer & Lernhelfer</h1>
             {% if current_user.is_authenticated %}
                <span class="user-greeting">Angemeldet als: {{ current_user.username }}</span>
            {% endif %}
        </header>

        <div class="lang-select-bar">
            <div class="lang-group">
                <label for="sourceLang">Ausgangssprache:</label>
                <select id="sourceLang" class="form-select">
                    <option value="de-DE">Deutsch</option>
                    <option value="en-US">Englisch</option>
                    <option value="fr-FR">Französisch</option>
                    <option value="es-ES">Spanisch</option>
                    <option value="ja-JP">Japanisch</option>
                    <!-- Fülle weitere Sprachen wie in deinem Original-HTML auf -->
                </select>
            </div>
            <button onclick="swapLanguagesAndText()" class="swap-button" title="Sprachen tauschen">
                <i class="bi bi-arrow-left-right"></i>
            </button>
            <div class="lang-group">
                <label for="targetLang">Zielsprache:</label>
                <select id="targetLang" class="form-select">
                    <option value="en-US">Englisch</option>
                    <option value="de-DE">Deutsch</option>
                    <option value="fr-FR">Französisch</option>
                    <option value="es-ES">Spanisch</option>
                    <option value="ja-JP">Japanisch</option>
                     <!-- Fülle weitere Sprachen wie in deinem Original-HTML auf -->
                </select>
            </div>
        </div>

        <div class="translator-grid">
            <div class="text-box-wrapper">
                <div id="inputText" contenteditable="true" class="text-box" oninput="handleInputTranslation()" onmouseup="handleSelection('lang1')" placeholder="Text hier eingeben..."></div>
                <div class="box-actions-toolbar">
                    <button class="btn-icon" onclick="toggleRecording()" id="micBtn" title="Spracheingabe (REC)">
                        <i class="bi bi-mic-fill"></i>
                    </button>
                    <button class="btn-icon" id="inputSpeaker" onclick="speakInputText()" title="Eingabetext vorlesen">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <div class="generate-wrapper">
                        <button class="btn-icon" id="generateDropdownBtn" title="Lerntext generieren">
                            <i class="bi bi-stars"></i>
                        </button>
                        <div class="generate-tooltip" id="generateTooltip">
                            <div onclick="generateLearningText('easy')"><span class="circle easy"></span> Einfach</div>
                            <div onclick="generateLearningText('medium')"><span class="circle medium"></span> Mittel</div>
                            <div onclick="generateLearningText('hard')"><span class="circle hard"></span> Schwer</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-box-wrapper">
                <div id="outputText" contenteditable="false" class="text-box" onmouseup="handleSelection('lang2')" placeholder="Übersetzung erscheint hier..."></div>
                 <div class="box-actions-toolbar">
                    <button class="btn-icon" id="outputSpeaker" onclick="speakOutputText()" title="Übersetzung vorlesen">
                        <i class="bi bi-volume-up-fill"></i>
                    </button>
                    <button class="btn-icon" onclick="generateGapFromOutput()" title="Lückentext erstellen">
                        <i class="bi bi-pencil-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="centered-action-buttons">
            <button onclick="clearHighlights()" class="btn btn-apple-style">
                <i class="bi bi-arrow-counterclockwise"></i> Markierungen löschen
            </button>
            {% if current_user.is_authenticated %}
            <div id="saveVocabWrapper" style="display: none;">
                <button onclick="saveVocabEntry()" class="btn btn-apple-style primary">
                    <i class="bi bi-star-fill"></i> Vokabel speichern
                </button>
            </div>
            {% endif %}
        </div>

        <div id="explanationBox" style="display: none;">
            <!-- Erklärung wird hier dynamisch eingefügt -->
        </div>
      </div> <!-- Ende .container-fluid -->
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Kompletter JavaScript Block von deiner vorherigen, funktionierenden index.html hier einfügen.
        // Stelle sicher, dass die IDs und Klassen mit dem neuen HTML übereinstimmen.
        // Das Sidebar-Toggle-Skript und der Logout-Handler sind hier wieder enthalten.

        // Sidebar Toggle Script
        const toggleSidebarBtnJS = document.getElementById('toggleSidebar');
        const sidebarElementJS = document.getElementById('sidebar');
        const mainContentElementJS = document.getElementById('mainContent'); 
        function setSidebarStateJS(collapsed) {
            const sidebarTexts = sidebarElementJS.querySelectorAll('.sidebar-text');
            if (collapsed) {
                sidebarElementJS.classList.add('collapsed');
                if(mainContentElementJS) mainContentElementJS.classList.add('collapsed');
                sidebarTexts.forEach(span => span.style.display = 'none');
            } else {
                sidebarElementJS.classList.remove('collapsed');
                if(mainContentElementJS) mainContentElementJS.classList.remove('collapsed');
                sidebarTexts.forEach(span => span.style.display = 'inline');
            }
        }
        const isSidebarCollapsedStored = localStorage.getItem('sidebarCollapsed') === 'true';
        setSidebarStateJS(isSidebarCollapsedStored);
        if (toggleSidebarBtnJS) {
            toggleSidebarBtnJS.addEventListener('click', function (e) {
              e.preventDefault();
              const shouldBeCollapsedJS = !sidebarElementJS.classList.contains('collapsed');
              localStorage.setItem('sidebarCollapsed', shouldBeCollapsedJS);
              setSidebarStateJS(shouldBeCollapsedJS);
            });
        }
        // Logout Button in der Sidebar
        const logoutButtonSidebarJS = document.getElementById('logoutButtonSidebar');
        if (logoutButtonSidebarJS) {
            logoutButtonSidebarJS.addEventListener('click', function(event) {
                event.preventDefault();
                fetch("{{ url_for('logout') }}").then(response => response.json()).then(data => {
                    if (data.status === 'success') { window.location.href = "{{ url_for('login') }}"; }
                    else { alert('Logout fehlgeschlagen: ' + (data.message || 'Unbekannter Fehler')); }
                }).catch(error => { console.error('Logout Fehler:', error); alert('Fehler beim Logout.'); });
            });
        }

        // Dein bestehendes JavaScript für die Übersetzer-Funktionalität
        let lastMatchedWord = null;
        let lastInputText = document.getElementById("inputText").innerText.trim();
        let lastOutputText = document.getElementById("outputText").innerText.trim();
        let translateTimer;
        const highlightColorsGlobal = ["#ffd500", "#39FF14", "#a200ff", "#00bfff", "#ff2b2b"];
        let highlightIndexGlobal = 0;

        function handleInputTranslation() {
            const text = document.getElementById("inputText").innerText.trim();
            const fullTargetLang = document.getElementById("targetLang").value;
            const targetLang = fullTargetLang.split("-")[0];
            clearTimeout(translateTimer);
            lastInputText = text;
            const outputField = document.getElementById("outputText");
            const saveVocabDiv = document.getElementById("saveVocabWrapper");

            if (text.length > 0) {
                translateTimer = setTimeout(() => {
                    fetch("{{ url_for('translate') }}", {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ text: text, target_lang: targetLang })
                    }).then(res => res.json()).then(data => {
                        if (data.error) {
                            console.error("Translate error:", data.error);
                            outputField.innerText = ""; lastOutputText = "";
                            if(saveVocabDiv) saveVocabDiv.style.display = "none"; return;
                        }
                        if (data.translated !== undefined) {
                            let displayText = "";
                            if (typeof data.translated === "object" && data.translated.translated !== undefined) {
                                lastOutputText = data.translated.translated;
                                displayText = data.translated.reading ? `${data.translated.translated} (${data.translated.reading})` : data.translated.translated;
                            } else if (typeof data.translated === 'string') {
                                lastOutputText = data.translated; displayText = data.translated;
                            }
                            outputField.innerText = displayText;
                        } else { outputField.innerText = ""; lastOutputText = ""; if(saveVocabDiv) saveVocabDiv.style.display = "none"; }
                    }).catch(err => { console.error("Network error on translate:", err); outputField.innerText = ""; lastOutputText = ""; if(saveVocabDiv) saveVocabDiv.style.display = "none";});
                }, 300);
            } else { outputField.innerText = ""; lastOutputText = ""; if(saveVocabDiv) saveVocabDiv.style.display = "none"; document.getElementById("explanationBox").style.display = "none"; }
        }
        document.getElementById("inputText").addEventListener("input", handleInputTranslation);

        function clearHighlights() {
            ["inputText", "outputText"].forEach(id => {
                const el = document.getElementById(id);
                el.innerHTML = el.innerText; // Nur den Text behalten, um alle Spans zu entfernen
            });
            document.getElementById("explanationBox").style.display = "none";
            document.getElementById("explanationBox").innerHTML = "";
            const saveWrapper = document.getElementById("saveVocabWrapper");
            if(saveWrapper) saveWrapper.style.display = "none";
            lastMatchedWord = null;
            highlightIndexGlobal = 0;
        }

        function handleSelection(langFromBox) { // Parameter umbenannt, um Konflikt mit globalem lang zu vermeiden
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText || selectedText.includes(" ") || selectedText.length > 50 || selectedText.length < 1) return;

            const currentInputText = document.getElementById("inputText").innerText; // Reinen Text holen
            const currentOutputText = document.getElementById("outputText").innerText; // Reinen Text holen

            // Wichtig: Stelle sicher, dass lastInputText und lastOutputText den reinen Text widerspiegeln
            // der für die Übersetzung verwendet wurde, nicht den mit HTML-Markup von Highlights.
            // handleInputTranslation sollte lastInputText und lastOutputText korrekt setzen.

            const payload = {
                sentence1: lastInputText, 
                sentence2: lastOutputText, 
                selectedWord: selectedText,
                selectedFrom: langFromBox,
                sourceLangCode: document.getElementById("sourceLang").value,
                targetLangCode: document.getElementById("targetLang").value
            };

            fetch("{{ url_for('match_word') }}", {
                method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
            }).then(res => res.json()).then(data => {
                if (data.error) { console.error("Matching Error:", data.error); return; }
                
                clearHighlights(); // Vor dem neuen Highlighting alte entfernen

                const color = highlightColorsGlobal[highlightIndexGlobal % highlightColorsGlobal.length];
                highlightIndexGlobal++;

                const applyHighlightsToBox = (boxId, words, isExplanationSource) => {
                    const box = document.getElementById(boxId);
                    if (!box || !words || words.length === 0) return;
                    let htmlContent = box.innerText; // Beginne mit reinem Text
                    words.forEach(wordToHighlight => {
                        const regex = new RegExp(`\\b(${wordToHighlight.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})(?![^<]*>|[^<>]*<\\/)`, "gi"); // Verhindert Highlighting in HTML-Tags
                        htmlContent = htmlContent.replace(regex, (match) => 
                            `<span class="highlight" style="background-color:${color};">${match}</span><span class="info-icon" onclick="fetchExplanation(event, '${match.replace(/'/g, "\\'")}', '${boxId}')"> ℹ️</span>`
                        );
                    });
                    box.innerHTML = htmlContent;
                };

                if (langFromBox === 'lang1') {
                    applyHighlightsToBox('inputText', data.originalMatches || [selectedText], true);
                    applyHighlightsToBox('outputText', data.translatedMatches, false);
                    lastMatchedWord = { original_word: selectedText, translated_word: (data.translatedMatches && data.translatedMatches.length > 0 ? data.translatedMatches[0] : "") };
                } else {
                    applyHighlightsToBox('outputText', data.translatedMatches || [selectedText], false);
                    applyHighlightsToBox('inputText', data.originalMatches, true);
                    lastMatchedWord = { original_word: (data.originalMatches && data.originalMatches.length > 0 ? data.originalMatches[0] : ""), translated_word: selectedText };
                }
                
                if (lastMatchedWord) {
                    lastMatchedWord.source_lang = document.getElementById("sourceLang").value;
                    lastMatchedWord.target_lang = document.getElementById("targetLang").value;
                    lastMatchedWord.original_sentence = lastInputText; 
                    lastMatchedWord.translated_sentence = lastOutputText; 
                    
                    const saveBtnWrapper = document.getElementById("saveVocabWrapper");
                    if (saveBtnWrapper && lastMatchedWord.original_word && lastMatchedWord.translated_word) {
                        saveBtnWrapper.style.display = "block";
                    } else {
                       if(saveBtnWrapper) saveBtnWrapper.style.display = "none";
                    }
                }
            }).catch(err => console.error("Matching API Error:", err));
        }

        function fetchExplanation(event, word, boxIdForSentence) {
            event.stopPropagation();
            const sentence = document.getElementById(boxIdForSentence).innerText; // Reinen Text für Kontext nehmen
            fetch("{{ url_for('explain') }}", {
                method: "POST", headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ sentence: sentence, word: word })
            }).then(res => res.json()).then(data => {
                const box = document.getElementById("explanationBox");
                if (data.explanation) {
                    box.innerHTML = `<h3>Erklärung für: <strong>${word}</strong></h3>${data.explanation}`;
                    box.style.display = "block";
                    box.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else { box.innerHTML = `<p class="text-danger">Fehler beim Laden der Erklärung.</p>`; box.style.display = "block";}
            }).catch(err => { console.error("Explanation Error:", err); /* ... */ });
        }

        // --- Dein restliches JavaScript für toggleRecording, speakInputText, speakOutputText, swapLanguagesAndText,
        // --- generateLearningText, Tooltip, generateGapFromOutput, Lückentext Enter-Handler, saveVocabEntry
        // --- hier einfügen und sicherstellen, dass die url_for() Aufrufe korrekt sind und
        // --- Element-IDs mit dem neuen HTML übereinstimmen.
        // --- playTTS in speakInputText und speakOutputText sollte den lang-Parameter korrekt übergeben.

        // Minimalbeispiele für die restlichen Funktionen (du musst deinen Code einfügen):
        let isRecording = false; let mediaRecorder; let audioChunks = [];
        function toggleRecording() { /* ... dein Code ... */ }
        function speakInputText() {
            const text = document.getElementById("inputText").innerText.trim();
            const lang = document.getElementById("sourceLang").value;
            if (!text) return;
            fetch("{{ url_for('tts') }}", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({text, lang})}).then(r => r.blob()).then(b => new Audio(URL.createObjectURL(b)).play());
        }
        function speakOutputText() {
            const text = document.getElementById("outputText").innerText.trim();
            const lang = document.getElementById("targetLang").value;
            if (!text) return;
            fetch("{{ url_for('tts') }}", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({text, lang})}).then(r => r.blob()).then(b => new Audio(URL.createObjectURL(b)).play());
        }
        function swapLanguagesAndText() {
            const sourceSelect = document.getElementById("sourceLang"); const targetSelect = document.getElementById("targetLang");
            const tempLang = sourceSelect.value; sourceSelect.value = targetSelect.value; targetSelect.value = tempLang;
            const inputBox = document.getElementById("inputText"); const outputBox = document.getElementById("outputText");
            const tempText = inputBox.innerText; inputBox.innerText = outputBox.innerText; outputBox.innerText = tempText;
            handleInputTranslation();
        }
        function generateLearningText(difficulty) {
            const langCodeFull = document.getElementById("sourceLang").value;
            const langCode = langCodeFull.split('-')[0]; // Nur 'de', 'en' etc.
            fetch("{{ url_for('generate_text_route') }}", { method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({language: langCode, difficulty})})
            .then(r=>r.json()).then(d=> { if(d.text) {document.getElementById("inputText").innerText = d.text; handleInputTranslation();} else console.error(d.error);});
        }
        const tooltip = document.getElementById("generateTooltip"); const generateBtn = document.getElementById("generateDropdownBtn");
        if(generateBtn && tooltip){ generateBtn.addEventListener("mouseenter", () => { tooltip.style.display = "block"; }); generateBtn.addEventListener("mouseleave", () => { setTimeout(() => { if (!tooltip.matches(':hover')) tooltip.style.display = "none"; }, 200); }); tooltip.addEventListener("mouseleave", () => { tooltip.style.display = "none"; }); }
        
        function generateGapFromOutput() {
            const sentence = document.getElementById("outputText").innerText.trim();
            if (!sentence) return;
            fetch("{{ url_for('gap_fill') }}", {method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify({sentence})})
            .then(r=>r.json()).then(d => {
                if(d.error || !d.gap_text || d.original_word === null) { alert("Lückentext konnte nicht erstellt werden."); return;}
                const html = d.gap_text.replace(/_____/g, `<input class="gap-input" type="text" data-solution="${d.original_word.replace(/"/g, '"')}">`);
                document.getElementById("outputText").innerHTML = html;
            });
        }
        document.getElementById("outputText").addEventListener("keydown", function(event) { // Geändert auf outputText für Lückentext
            if (event.key === "Enter" && event.target.classList.contains("gap-input")) {
                event.preventDefault(); const inputEl = event.target; const userAns = inputEl.value.trim();
                const solution = inputEl.dataset.solution?.trim(); if(!solution) return;
                const replacement = document.createElement('strong'); replacement.textContent = solution;
                if(userAns.toLowerCase() === solution.toLowerCase()) { replacement.style.color = 'var(--accent-color-green)';} 
                else { replacement.style.color = 'var(--accent-color-red)'; 
                       const wrong = document.createElement('span'); wrong.style.textDecoration = 'line-through'; wrong.textContent = userAns + ' ';
                       inputEl.parentNode.insertBefore(wrong, inputEl);
                }
                inputEl.parentNode.replaceChild(replacement, inputEl);
            }
        });
        function saveVocabEntry() {
            if (!lastMatchedWord || !lastMatchedWord.original_word || !lastMatchedWord.translated_word) { alert("Keine gültige Vokabel zum Speichern ausgewählt."); return; }
            fetch("{{ url_for('save_vocab_route') }}", {method: "POST", headers: {"Content-Type": "application/json"}, body: JSON.stringify(lastMatchedWord)})
            .then(r=>r.json()).then(d => {
                if(d.status === 'success') { alert("✅ Vokabel gespeichert!");} 
                else { alert("❌ Fehler: " + (d.message || "Unbekannt")); }
                document.getElementById("saveVocabWrapper").style.display = 'none'; lastMatchedWord = null;
            }).catch(e => alert("Netzwerkfehler."));
        }

    </script>
</body>
</html>